<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Einstellungen - Restaurant-Verwaltung</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* Categoria Management Styles */
        .category-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .category-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #7f8c8d;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
        }

        .category-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background: #f8f9fa;
        }

        .category-tab:hover {
            background: #f8f9fa;
            color: #3498db;
        }

        .category-content {
            display: none;
            padding: 20px 0;
        }

        .category-content.active {
            display: block;
        }

        .category-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e1e8ed;
            border-radius: 10px;
        }

        .categories-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 10px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .category-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-color: #3498db;
        }

        .category-item.custom {
            border-left: 4px solid #e74c3c;
            background: linear-gradient(135deg, #ffffff 0%, #fdf2f2 100%);
        }

        .category-item.default {
            border-left: 4px solid #27ae60;
            background: linear-gradient(135deg, #ffffff 0%, #f8fff9 100%);
        }

        .category-label {
            font-weight: 600;
            color: #2c3e50;
        }

        .category-badge {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
        }

        .category-badge.custom {
            background: #e74c3c;
        }

        .category-badge.default {
            background: #27ae60;
        }

        .category-actions {
            display: flex;
            gap: 5px;
        }

        .category-actions .btn {
            padding: 6px 10px;
            font-size: 0.9em;
        }

        .file-upload {
            border: 2px dashed #3498db;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .file-upload:hover {
            background: #f8f9fa;
            border-color: #2980b9;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .modal .btn {
            margin: 10px 5px;
        }

        .overview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-item h4 {
            margin: 0 0 10px 0;
            font-size: 1.1rem;
        }

        .stat-item .value {
            font-size: 2rem;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .category-tabs {
                flex-direction: column;
            }
            
            .category-tab {
                text-align: center;
                border-bottom: 2px solid transparent;
            }
            
            .categories-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>‚öôÔ∏è Einstellungen</h1>
            <p>Daten verwalten und Systemeinstellungen</p>
        </div>
    </header>

    <div class="container">
        <!-- Navega√ß√£o -->
        <div class="nav-buttons">
            <button class="nav-button" onclick="navigateTo('dashboard')">
                <span class="icon icon-home"></span>
                √úbersicht
            </button>
        </div>

        <!-- Informa√ß√µes do sistema -->
        <div class="card">
            <h2>Systeminformationen</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalTransactions">0</div>
                    <div class="stat-label">Kassenfluss Eintr√§ge</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalInventoryItems">0</div>
                    <div class="stat-label">Inventar Artikel</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRecurringPayments">0</div>
                    <div class="stat-label">Wiederkehrende Zahlungen</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lastSaved">Nie</div>
                    <div class="stat-label">Zuletzt gespeichert</div>
                </div>
            </div>
        </div>

        <!-- Configura√ß√µes do restaurante -->
        <div class="card">
            <h2>Restaurant Einstellungen</h2>
            <form id="settingsForm">
                <div class="form-group">
                    <label for="restaurantName">Restaurant Name:</label>
                    <input type="text" id="restaurantName" placeholder="Mein Restaurant" required>
                </div>
                
                <div class="form-group">
                    <label for="currency">W√§hrung:</label>
                    <select id="currency" disabled>
                        <option value="EUR">Euro (‚Ç¨)</option>
                    </select>
                    <small style="color: #7f8c8d;">Die W√§hrung ist derzeit auf Euro festgelegt</small>
                </div>
                
                <button type="submit" class="btn btn-success">
                    <span class="icon icon-save"></span>
                    Einstellungen speichern
                </button>
            </form>
        </div>

        <!-- Kategorien-Verwaltung -->
        <div class="card">
            <h2>üè∑Ô∏è Kategorien verwalten</h2>
            <p style="margin-bottom: 25px; color: #7f8c8d; line-height: 1.6;">
                Hier k√∂nnen Sie benutzerdefinierte Kategorien f√ºr alle Module erstellen und verwalten.
                Diese Kategorien werden in Formularen und Berichten verwendet.
            </p>
            
            <!-- Tabs f√ºr verschiedene Kategorietypen -->
            <div class="category-tabs" style="display: flex; border-bottom: 2px solid #e1e8ed; margin-bottom: 20px;">
                <button class="category-tab active" onclick="showCategoryTab('financial')" data-tab="financial">
                    üí∞ Finanzen
                </button>
                <button class="category-tab" onclick="showCategoryTab('recurring')" data-tab="recurring">
                    üîÑ Zahlungen
                </button>
                <button class="category-tab" onclick="showCategoryTab('inventory')" data-tab="inventory">
                    üì¶ Inventar
                </button>
                <button class="category-tab" onclick="showCategoryTab('preparations')" data-tab="preparations">
                    üç≥ K√ºche
                </button>
                <button class="category-tab" onclick="showCategoryTab('employeeRoles')" data-tab="employeeRoles">
                    üë• Personal
                </button>
            </div>

            <!-- Financial Categories -->
            <div id="financial-categories" class="category-content active">
                <h3>üí∞ Finanz-Kategorien</h3>
                
                <!-- Einnahmen -->
                <div class="category-section">
                    <h4 style="color: #27ae60; margin-bottom: 15px;">üìà Einnahme-Kategorien</h4>
                    <div class="category-form" style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                        <div style="display: flex; gap: 10px; align-items: end;">
                            <div class="form-group" style="flex: 1;">
                                <label for="newIncomeCategory">Neue Kategorie:</label>
                                <input type="text" id="newIncomeCategory" placeholder="z.B. Catering-Privat">
                            </div>
                            <button class="btn btn-success" onclick="addFinancialCategory('income')">
                                <span class="icon">+</span>
                                Hinzuf√ºgen
                            </button>
                        </div>
                    </div>
                    <div id="income-categories-list" class="categories-list"></div>
                </div>

                <!-- Ausgaben -->
                <div class="category-section">
                    <h4 style="color: #e74c3c; margin-bottom: 15px;">üìâ Ausgabe-Kategorien</h4>
                    <div class="category-form" style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                        <div style="display: flex; gap: 10px; align-items: end;">
                            <div class="form-group" style="flex: 1;">
                                <label for="newExpenseCategory">Neue Kategorie:</label>
                                <input type="text" id="newExpenseCategory" placeholder="z.B. Spezialzutaten">
                            </div>
                            <button class="btn btn-success" onclick="addFinancialCategory('expense')">
                                <span class="icon">+</span>
                                Hinzuf√ºgen
                            </button>
                        </div>
                    </div>
                    <div id="expense-categories-list" class="categories-list"></div>
                </div>
            </div>

            <!-- Recurring Categories -->
            <div id="recurring-categories" class="category-content">
                <h3>üîÑ Wiederkehrende Zahlungen - Kategorien</h3>
                <div class="category-form" style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                    <div style="display: flex; gap: 10px; align-items: end;">
                        <div class="form-group" style="flex: 1;">
                            <label for="newRecurringCategory">Neue Kategorie:</label>
                            <input type="text" id="newRecurringCategory" placeholder="z.B. Software-Lizenzen">
                        </div>
                        <button class="btn btn-success" onclick="addSingleCategory('recurring')">
                            <span class="icon">+</span>
                            Hinzuf√ºgen
                        </button>
                    </div>
                </div>
                <div id="recurring-categories-list" class="categories-list"></div>
            </div>

            <!-- Inventory Categories -->
            <div id="inventory-categories" class="category-content">
                <h3>üì¶ Inventar - Kategorien</h3>
                <div class="category-form" style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                    <div style="display: flex; gap: 10px; align-items: end;">
                        <div class="form-group" style="flex: 1;">
                            <label for="newInventoryCategory">Neue Kategorie:</label>
                            <input type="text" id="newInventoryCategory" placeholder="z.B. Exotische Fr√ºchte">
                        </div>
                        <button class="btn btn-success" onclick="addSingleCategory('inventory')">
                            <span class="icon">+</span>
                            Hinzuf√ºgen
                        </button>
                    </div>
                </div>
                <div id="inventory-categories-list" class="categories-list"></div>
            </div>

            <!-- Preparations Categories -->
            <div id="preparations-categories" class="category-content">
                <h3>üç≥ K√ºche/Vorbereitungen - Kategorien</h3>
                <div class="category-form" style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                    <div style="display: flex; gap: 10px; align-items: end;">
                        <div class="form-group" style="flex: 1;">
                            <label for="newPreparationCategory">Neue Kategorie:</label>
                            <input type="text" id="newPreparationCategory" placeholder="z.B. Pasta-Zubereitung">
                        </div>
                        <button class="btn btn-success" onclick="addSingleCategory('preparations')">
                            <span class="icon">+</span>
                            Hinzuf√ºgen
                        </button>
                    </div>
                </div>
                <div id="preparations-categories-list" class="categories-list"></div>
            </div>

            <!-- Employee Roles -->
            <div id="employeeRoles-categories" class="category-content">
                <h3>üë• Personal - Rollen</h3>
                <div class="category-form" style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                    <div style="display: flex; gap: 10px; align-items: end;">
                        <div class="form-group" style="flex: 1;">
                            <label for="newEmployeeRole">Neue Rolle:</label>
                            <input type="text" id="newEmployeeRole" placeholder="z.B. Pizzaiolo">
                        </div>
                        <button class="btn btn-success" onclick="addSingleCategory('employeeRoles')">
                            <span class="icon">+</span>
                            Hinzuf√ºgen
                        </button>
                    </div>
                </div>
                <div id="employeeRoles-categories-list" class="categories-list"></div>
            </div>
        </div>

        <!-- Automatisches Speichersystem -->
        <div class="card" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #28a745;">
            <h2 style="color: #28a745;">üíæ Automatisches Speichersystem</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">‚úÖ Automatisches Speichern Aktiv</h4>
                    <p style="color: #7f8c8d; margin-bottom: 15px; line-height: 1.6;">
                        Ihre Daten werden automatisch im Browser bei jeder √Ñnderung gespeichert. 
                        Manuelles Speichern ist nicht erforderlich!
                    </p>
                </div>
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">‚å®Ô∏è Tastaturk√ºrzel</h4>
                    <ul style="color: #7f8c8d; line-height: 1.8; margin: 0; padding-left: 20px;">
                        <li><strong>Strg+S</strong> - Schnelles Speichern</li>
                        <li><strong>Strg+E</strong> - Backup erstellen (Download)</li>
                    </ul>
                </div>
            </div>
            <div style="text-align: center; padding: 20px; background: rgba(40, 167, 69, 0.1); border-radius: 10px; margin-top: 20px;">
                <p style="color: #28a745; font-weight: bold; margin: 0;">
                    üîí Sichere Daten: Automatisches Speichern alle 30 Sekunden oder sofort nach √Ñnderungen
                </p>
            </div>
        </div>

        <!-- Export und Import von Daten -->
        <div class="card">
            <h2>Daten verwalten (Backup Manual)</h2>
            <p style="margin-bottom: 25px; color: #7f8c8d; line-height: 1.6;">
                Hier k√∂nnen Sie alle Ihre Restaurantdaten als JSON-Datei exportieren oder eine zuvor gespeicherte Datei importieren.
                <strong>Wichtig:</strong> Beim Import werden alle aktuellen Daten √ºberschrieben!
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
                <!-- Export -->
                <div style="text-align: center; padding: 30px; background: #f8f9fa; border-radius: 15px;">
                    <span class="icon icon-download" style="font-size: 3em; margin-bottom: 20px; display: block;"></span>
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">Daten exportieren</h3>
                    <p style="margin-bottom: 20px; color: #7f8c8d;">
                        Alle Daten als JSON-Datei herunterladen
                    </p>
                    <button class="btn btn-success" onclick="exportAllData()">
                        <span class="icon icon-download"></span>
                        Daten herunterladen
                    </button>
                </div>
                
                <!-- Import -->
                <div style="text-align: center; padding: 30px; background: #f8f9fa; border-radius: 15px;">
                    <span class="icon icon-upload" style="font-size: 3em; margin-bottom: 20px; display: block;"></span>
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">Daten importieren</h3>
                    <p style="margin-bottom: 20px; color: #7f8c8d;">
                        JSON-Datei hochladen und importieren
                    </p>
                    <div class="file-upload" onclick="document.getElementById('importFile').click()">
                        <input type="file" id="importFile" accept=".json" onchange="handleFileImport(event)">
                        <span class="icon icon-upload" style="font-size: 2em; margin-bottom: 10px; display: block;"></span>
                        <p><strong>Hier klicken oder Datei hierher ziehen</strong></p>
                        <p style="font-size: 0.9em; color: #7f8c8d;">Nur JSON-Dateien werden akzeptiert</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backup und Datenbereinigung -->
        <div class="card">
            <h2>Erweiterte Optionen</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                
                <div style="padding: 20px; border: 2px solid #3498db; border-radius: 10px;">
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">üîÑ Daten zur√ºcksetzen</h4>
                    <p style="color: #7f8c8d; margin-bottom: 15px; font-size: 0.9em;">
                        Alle gespeicherten Daten l√∂schen und das System zur√ºcksetzen
                    </p>
                    <button class="btn btn-warning" onclick="resetAllData()">
                        <span class="icon icon-delete"></span>
                        Alle Daten l√∂schen
                    </button>
                </div>
                
                <div style="padding: 20px; border: 2px solid #27ae60; border-radius: 10px;">
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">üìä Daten√ºbersicht</h4>
                    <p style="color: #7f8c8d; margin-bottom: 15px; font-size: 0.9em;">
                        Detaillierte Informationen √ºber gespeicherte Daten anzeigen
                    </p>
                    <button class="btn btn-success" onclick="showDataOverview()">
                        <span class="icon icon-settings"></span>
                        √úbersicht anzeigen
                    </button>
                </div>
                
                <div style="padding: 20px; border: 2px solid #e74c3c; border-radius: 10px;">
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">üíæ Lokaler Speicher</h4>
                    <p style="color: #7f8c8d; margin-bottom: 15px; font-size: 0.9em;">
                        Lokalen Browser-Speicher leeren (localStorage)
                    </p>
                    <button class="btn btn-danger" onclick="clearLocalStorage()">
                        <span class="icon icon-delete"></span>
                        Cache leeren
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal f√ºr Daten√ºbersicht -->
        <div id="dataModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto;">
                <h3 style="margin-bottom: 20px;">Daten√ºbersicht</h3>
                <div id="dataOverviewContent"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="closeDataModal()">Schlie√üen</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/eventBus.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/autoSave.js"></script>
    <script src="../js/restaurant-header.js"></script>
    <script>
        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // CORRIGIDO: Carregar dados ANTES de verificar sele√ß√£o
            loadDataFromStorage();
            
            // FOR√áAR SELE√á√ÉO DE RESTAURANTE SE N√ÉO ESTIVER SELECIONADO
            if (!isRestaurantSelected()) {
                alert('Bitte w√§hlen Sie zuerst ein Restaurant aus!');
                window.location.href = '../index.html';
                return;
            }
            
            initSettingsPage();
            updateSystemInfo();
            loadSettings();
            initializeCategoryManagement();
        });

        /**
         * Inicializa a p√°gina de configura√ß√µes
         */
        function initSettingsPage() {
            // Event listener para formul√°rio de configura√ß√µes
            document.getElementById('settingsForm').addEventListener('submit', handleSettingsSubmit);
            
            // Configurar drag and drop para import
            const fileUpload = document.querySelector('.file-upload');
            
            fileUpload.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#3498db';
                this.style.background = '#ecf0f1';
            });
            
            fileUpload.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.borderColor = '#bdc3c7';
                this.style.background = 'transparent';
            });
            
            fileUpload.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '#bdc3c7';
                this.style.background = 'transparent';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileImport({ target: { files: files } });
                }
            });
        }

        /**
         * Atualiza informa√ß√µes do sistema
         */
        function updateSystemInfo() {
            const restaurantData = getCurrentRestaurantData();
            if (restaurantData) {
                document.getElementById('totalTransactions').textContent = (restaurantData.cashflow || []).length;
                document.getElementById('totalInventoryItems').textContent = (restaurantData.inventory || []).length;
                document.getElementById('totalRecurringPayments').textContent = (restaurantData.recurring || []).length;
            }
            
            // Pr√ºfen wann zuletzt gespeichert wurde
            const lastSaved = localStorage.getItem('restaurant_data_last_saved');
            if (lastSaved) {
                const lastSavedDate = new Date(lastSaved);
                document.getElementById('lastSaved').textContent = formatDate(lastSavedDate);
            } else {
                document.getElementById('lastSaved').textContent = 'Nie';
            }
        }

        /**
         * L√§dt aktuelle Einstellungen
         */
        function loadSettings() {
            const restaurantData = getCurrentRestaurantData();
            if (restaurantData && restaurantData.settings) {
                document.getElementById('restaurantName').value = restaurantData.settings.restaurantName || 'Mein Restaurant';
                document.getElementById('currency').value = restaurantData.settings.currency || 'EUR';
            }
        }

        /**
         * Behandelt Einstellungen-Formular
         */
        function handleSettingsSubmit(e) {
            e.preventDefault();
            
            const restaurantData = getCurrentRestaurantData();
            if (restaurantData) {
                if (!restaurantData.settings) restaurantData.settings = {};
                restaurantData.settings.restaurantName = document.getElementById('restaurantName').value;
                restaurantData.settings.currency = document.getElementById('currency').value;
            }
            
            saveDataToStorage();
            localStorage.setItem('restaurant_data_last_saved', new Date().toISOString());
            
            updateSystemInfo();
            showNotification('Einstellungen erfolgreich gespeichert', 'success');
        }

        /**
         * Exportiert alle Daten
         */
        function exportAllData() {
            try {
                const success = exportData();
                if (success) {
                    localStorage.setItem('restaurant_data_last_saved', new Date().toISOString());
                    updateSystemInfo();
                    showNotification('Daten erfolgreich exportiert', 'success');
                }
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Fehler beim Exportieren der Daten', 'error');
            }
        }

        /**
         * Behandelt Datei-Import
         */
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                showNotification('Bitte w√§hlen Sie eine JSON-Datei aus', 'error');
                return;
            }
            
            if (confirm('Achtung: Alle aktuellen Daten werden √ºberschrieben! M√∂chten Sie fortfahren?')) {
                importData(file)
                    .then(() => {
                        localStorage.setItem('restaurant_data_last_saved', new Date().toISOString());
                        updateSystemInfo();
                        showNotification('Daten erfolgreich importiert. Seite wird neu geladen...', 'success');
                        
                        // Seite nach 2 Sekunden neu laden
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    })
                    .catch(error => {
                        console.error('Import error:', error);
                        showNotification('Fehler beim Importieren: ' + error.message, 'error');
                    });
            }
            
            // Reset input
            event.target.value = '';
        }

        /**
         * Setzt alle Daten zur√ºck
         */
        function resetAllData() {
            const confirmation = prompt('Um alle Daten zu l√∂schen, geben Sie "L√ñSCHEN" ein:');
            
            if (confirmation === 'L√ñSCHEN') {
                // Reset current restaurant data
                const restaurantData = getCurrentRestaurantData();
                if (restaurantData) {
                    restaurantData.cashflow = [];
                    restaurantData.inventory = [];
                    restaurantData.employees = [];
                    restaurantData.preparations = [];
                    restaurantData.shopping = [];
                    restaurantData.settings = {
                        restaurantName: getCurrentRestaurantName(),
                        currency: '‚Ç¨'
                    };
                }
                
                saveDataToStorage();
                localStorage.removeItem('restaurant_data_last_saved');
                
                updateSystemInfo();
                loadSettings();
                
                showNotification('Alle Daten wurden erfolgreich gel√∂scht', 'success');
            } else if (confirmation !== null) {
                showNotification('Falsche Eingabe. Daten wurden nicht gel√∂scht.', 'error');
            }
        }

        /**
         * L√∂scht localStorage
         */
        function clearLocalStorage() {
            if (confirm('Sind Sie sicher, dass Sie den lokalen Cache leeren m√∂chten?')) {
                localStorage.clear();
                showNotification('Lokaler Cache wurde geleert', 'success');
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }
        }

        /**
         * Zeigt Daten√ºbersicht
         */
        function showDataOverview() {
            const modal = document.getElementById('dataModal');
            const content = document.getElementById('dataOverviewContent');
            
            // Detaillierte Statistiken berechnen
            const restaurantData = getCurrentRestaurantData();
            if (!restaurantData) return;
            
            const totalIncome = (restaurantData.cashflow || [])
                .filter(entry => entry.typ === 'einnahme')
                .reduce((sum, entry) => sum + parseFloat(entry.betrag || 0), 0);
            
            const totalExpenses = (restaurantData.cashflow || [])
                .filter(entry => entry.typ === 'ausgabe')
                .reduce((sum, entry) => sum + parseFloat(entry.betrag || 0), 0);
            
            const inventoryValue = (restaurantData.inventory || [])
                .reduce((sum, item) => sum + ((item.bestand || 0) * (item.preis || 0)), 0);
            
            const monthlyRecurringCosts = (restaurantData.recurring || []).reduce((sum, payment) => {
                let monthlyAmount = 0;
                switch (payment.frequency) {
                    case 'weekly': monthlyAmount = payment.amount * 4.33; break;
                    case 'monthly': monthlyAmount = payment.amount; break;
                    case 'quarterly': monthlyAmount = payment.amount / 3; break;
                    case 'yearly': monthlyAmount = payment.amount / 12; break;
                    case 'custom': monthlyAmount = payment.amount; break;
                }
                return sum + monthlyAmount;
            }, 0);
            
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-value">${formatCurrency(totalIncome)}</div>
                        <div class="stat-label">Gesamte Einnahmen</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatCurrency(totalExpenses)}</div>
                        <div class="stat-label">Gesamte Ausgaben</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatCurrency(totalIncome - totalExpenses)}</div>
                        <div class="stat-label">Nettosaldo</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatCurrency(inventoryValue)}</div>
                        <div class="stat-label">Inventarwert</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatCurrency(monthlyRecurringCosts)}</div>
                        <div class="stat-label">Monatliche Fixkosten</div>
                    </div>
                </div>
                
                <h4>Kategorieverteilung Kassenfluss:</h4>
                <div style="margin-bottom: 20px;">
                    ${generateCategoryBreakdown()}
                </div>
                
                <h4>Inventar Status:</h4>
                <div style="margin-bottom: 20px;">
                    ${generateInventoryStatus()}
                </div>
                
                <h4>Systemdaten:</h4>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.9em;">
                    <p><strong>Datengr√∂√üe:</strong> ${(JSON.stringify(restaurantData).length / 1024).toFixed(2)} KB</p>
                    <p><strong>Erstellt:</strong> ${new Date().toLocaleString('de-DE')}</p>
                    <p><strong>Browser:</strong> ${navigator.userAgent.split(')')[0]})</p>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        /**
         * Erstellt Kategorien-Aufschl√ºsselung
         */
        function generateCategoryBreakdown() {
            const categories = {};
            
            (restaurantData.cashflow || []).forEach(entry => {
                if (!categories[entry.category]) {
                    categories[entry.category] = { income: 0, expense: 0 };
                }
                if (entry.type === 'income') {
                    categories[entry.category].income += entry.amount;
                } else {
                    categories[entry.category].expense += entry.amount;
                }
            });
            
            return Object.keys(categories).map(category => {
                const cat = categories[category];
                return `
                    <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #ecf0f1;">
                        <span>${category}</span>
                        <span>+${formatCurrency(cat.income)} / -${formatCurrency(cat.expense)}</span>
                    </div>
                `;
            }).join('');
        }

        /**
         * Erstellt Inventar-Status
         */
        function generateInventoryStatus() {
            const lowStock = (restaurantData.inventory || []).filter(item => (item.bestand || 0) > 0 && (item.bestand || 0) <= (item.mindestbestand || 0)).length;
            const outOfStock = (restaurantData.inventory || []).filter(item => (item.bestand || 0) <= 0).length;
            const adequate = (restaurantData.inventory || []).filter(item => (item.bestand || 0) > (item.mindestbestand || 0)).length;
            
            return `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <div style="text-align: center; padding: 10px; background: #d5f4e6; border-radius: 8px;">
                        <strong style="color: #27ae60;">${adequate}</strong><br>
                        <small>Ausreichend</small>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #ffeaa7; border-radius: 8px;">
                        <strong style="color: #f39c12;">${lowStock}</strong><br>
                        <small>Niedrig</small>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #fab1a0; border-radius: 8px;">
                        <strong style="color: #e74c3c;">${outOfStock}</strong><br>
                        <small>Ausverkauft</small>
                    </div>
                </div>
            `;
        }

        /**
         * Schlie√üt Daten-Modal
         */
        function closeDataModal() {
            document.getElementById('dataModal').style.display = 'none';
        }

        // ====== KATEGORIEN-MANAGEMENT ======

        /**
         * Zeigt einen Kategorie-Tab
         */
        function showCategoryTab(tabName) {
            // Alle Tabs deaktivieren
            document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.category-content').forEach(content => content.classList.remove('active'));
            
            // Ausgew√§hlten Tab aktivieren
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-categories`).classList.add('active');
            
            // Kategorien f√ºr diesen Tab laden
            loadCategoriesForTab(tabName);
        }

        /**
         * L√§dt Kategorien f√ºr einen bestimmten Tab
         */
        function loadCategoriesForTab(tabName) {
            console.log('[DEBUG] loadCategoriesForTab chamada para:', tabName);
            
            if (tabName === 'financial') {
                loadFinancialCategories();
            } else {
                // Para outros tipos, tentar carregar ou mostrar mensagem
                try {
                    loadSingleTypeCategories(tabName);
                } catch(error) {
                    console.log('[DEBUG] Erro ao carregar', tabName, ':', error.message);
                    const container = document.getElementById(`${tabName}-categories-list`);
                    if (container) {
                        container.innerHTML = '<p style="color: #e74c3c;">Sistema principal n√£o dispon√≠vel. Verwenden Sie den Finanz-Tab.</p>';
                    }
                }
            }
        }

        /**
         * L√§dt finanzielle Kategorien (Income + Expense)
         */
        function loadFinancialCategories() {
            console.log('[DEBUG] loadFinancialCategories chamada');
            loadFinancialCategoryType('income');
            loadFinancialCategoryType('expense');
        }

        /**
         * L√§dt Kategorien f√ºr Income oder Expense
         */
        function loadFinancialCategoryType(type) {
            const container = document.getElementById(`${type}-categories-list`);
            
            // Tentar carregar do sistema principal primeiro
            if (typeof getAllCategories !== 'undefined' && typeof getCustomCategories !== 'undefined') {
                try {
                    const allCategories = getAllCategories('financial', type);
                    const customCategories = getCustomCategories('financial', type);
                    
                    if (allCategories.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-style: italic;">Keine Kategorien verf√ºgbar</p>';
                        return;
                    }

                    container.innerHTML = allCategories.map(category => {
                        const isCustom = customCategories.some(custom => custom.value === category.value);
                        return `
                            <div class="category-item ${isCustom ? 'custom' : 'default'}">
                                <div>
                                    <span class="category-label">${category.label}</span>
                                    <span class="category-badge ${isCustom ? 'custom' : 'default'}">
                                        ${isCustom ? 'Benutzerdefiniert' : 'Standard'}
                                    </span>
                                </div>
                                ${isCustom ? `
                                    <div class="category-actions">
                                        <button class="btn btn-danger" onclick="removeFinancialCategory('${type}', '${category.value}')">
                                            üóëÔ∏è L√∂schen
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                    return;
                } catch(error) {
                    console.log('[DEBUG] Erro ao carregar categorias do sistema principal:', error.message);
                }
            }
            
            // FALLBACK: Carregar do localStorage
            console.log('[FALLBACK] Carregando categorias do localStorage');
            loadFinancialCategoryTypeFallback(type);
        }

        /**
         * Fallback para carregar categorias do localStorage
         */
        function loadFinancialCategoryTypeFallback(type) {
            const container = document.getElementById(`${type}-categories-list`);
            
            // Carregar categorias do localStorage
            let categories = {};
            try {
                const stored = localStorage.getItem('custom_categories_fallback');
                if (stored) {
                    categories = JSON.parse(stored);
                }
            } catch(e) {
                console.log('[FALLBACK] Erro ao carregar categorias:', e.message);
            }
            
            // Categorias padr√£o
            const defaultCategories = {
                income: [
                    { value: 'food_sales', label: 'Verkauf Speisen' },
                    { value: 'drink_sales', label: 'Verkauf Getr√§nke' },
                    { value: 'catering', label: 'Catering' },
                    { value: 'events', label: 'Events' }
                ],
                expense: [
                    { value: 'ingredients', label: 'Zutaten' },
                    { value: 'rent', label: 'Miete' },
                    { value: 'utilities', label: 'Nebenkosten' },
                    { value: 'equipment', label: 'Ausstattung' },
                    { value: 'staff', label: 'Personal' },
                    { value: 'maintenance', label: 'Wartung' }
                ]
            };
            
            // Combinar categorias padr√£o e customizadas
            const defaultCats = defaultCategories[type] || [];
            const customCats = (categories.financial && categories.financial[type]) ? categories.financial[type] : [];
            
            if (defaultCats.length === 0 && customCats.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-style: italic;">Keine Kategorien verf√ºgbar</p>';
                return;
            }
            
            let html = '';
            
            // Mostrar categorias padr√£o
            defaultCats.forEach(category => {
                html += `
                    <div class="category-item default" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px;">
                        <div>
                            <span class="category-label" style="font-weight: 500;">${category.label}</span>
                            <span class="category-badge default" style="margin-left: 10px; padding: 2px 8px; background: #28a745; color: white; border-radius: 12px; font-size: 11px;">Standard</span>
                        </div>
                    </div>
                `;
            });
            
            // Mostrar categorias customizadas
            customCats.forEach(category => {
                html += `
                    <div class="category-item custom" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
                        <div>
                            <span class="category-label" style="font-weight: 500;">${category.label}</span>
                            <span class="category-badge custom" style="margin-left: 10px; padding: 2px 8px; background: #dc3545; color: white; border-radius: 12px; font-size: 11px;">Benutzerdefiniert</span>
                        </div>
                        <button onclick="removeFallbackCategory('${type}', '${category.value}')" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                            üóëÔ∏è L√∂schen
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        /**
         * Remove categoria do fallback
         */
        function removeFallbackCategory(type, value) {
            if (!confirm('M√∂chten Sie diese Kategorie wirklich l√∂schen?')) {
                return;
            }
            
            try {
                let categories = {};
                const stored = localStorage.getItem('custom_categories_fallback');
                if (stored) {
                    categories = JSON.parse(stored);
                }
                
                if (categories.financial && categories.financial[type]) {
                    categories.financial[type] = categories.financial[type].filter(cat => cat.value !== value);
                    localStorage.setItem('custom_categories_fallback', JSON.stringify(categories));
                    loadFinancialCategoryType(type);
                    alert('Kategorie erfolgreich gel√∂scht');
                }
            } catch(e) {
                alert('Fehler beim L√∂schen der Kategorie');
            }
        }

        /**
         * L√§dt Kategorien f√ºr einen einzelnen Typ
         */
        function loadSingleTypeCategories(type) {
            const container = document.getElementById(`${type}-categories-list`);
            const allCategories = getAllCategories(type);
            const customCategories = getCustomCategories(type);
            
            if (allCategories.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-style: italic;">Keine Kategorien verf√ºgbar</p>';
                return;
            }

            container.innerHTML = allCategories.map(category => {
                const isCustom = customCategories.some(custom => custom.value === category.value);
                return `
                    <div class="category-item ${isCustom ? 'custom' : 'default'}">
                        <div>
                            <span class="category-label">${category.label}</span>
                            <span class="category-badge ${isCustom ? 'custom' : 'default'}">
                                ${isCustom ? 'Benutzerdefiniert' : 'Standard'}
                            </span>
                        </div>
                        ${isCustom ? `
                            <div class="category-actions">
                                <button class="btn btn-danger" onclick="removeSingleCategory('${type}', '${category.value}')">
                                    üóëÔ∏è L√∂schen
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        /**
         * F√ºgt finanzielle Kategorie hinzu
         */
        function addFinancialCategory(type) {
            console.log('[DEBUG] addFinancialCategory chamada com type:', type);
            
            const input = document.getElementById(`new${type.charAt(0).toUpperCase() + type.slice(1)}Category`);
            console.log('[DEBUG] Input encontrado:', input ? 'SIM' : 'N√ÉO');
            
            if (!input) {
                alert('ERRO: Input n√£o encontrado para tipo ' + type);
                return;
            }
            
            const label = input.value.trim();
            console.log('[DEBUG] Label:', label);
            
            if (!label) {
                alert('Bitte geben Sie einen Kategorienamen ein');
                return;
            }

            // FALLBACK: Se main.js n√£o carregou, usar localStorage diretamente
            if (typeof addCustomCategory === 'undefined') {
                console.log('[DEBUG] main.js n√£o carregado, usando fallback');
                addCategoryFallback(type, label);
                return;
            }

            // Verificar se restaurante est√° selecionado
            try {
                const currentRestaurant = getCurrentRestaurant();
                console.log('[DEBUG] Restaurant atual:', currentRestaurant);
                
                if (!currentRestaurant) {
                    alert('Bitte w√§hlen Sie zuerst ein Restaurant aus!');
                    window.location.href = '../index.html';
                    return;
                }
            } catch(error) {
                console.log('[DEBUG] Erro ao verificar restaurante:', error.message);
                addCategoryFallback(type, label);
                return;
            }

            // Wert aus Label erstellen (lowercase, ohne Sonderzeichen)
            const value = label.toLowerCase().replace(/[^a-z0-9]/g, '_');
            console.log('[DEBUG] Valor gerado:', value);
            
            try {
                const result = addCustomCategory('financial', value, label, type);
                console.log('[DEBUG] Resultado addCustomCategory:', result);
                
                if (result) {
                    input.value = '';
                    loadFinancialCategoryType(type);
                    alert(`${type === 'income' ? 'Einnahme' : 'Ausgabe'}-Kategorie "${label}" erfolgreich hinzugef√ºgt!`);
                } else {
                    alert('ERRO: addCustomCategory retornou false');
                }
            } catch(error) {
                console.error('[DEBUG] ERRO:', error);
                addCategoryFallback(type, label);
            }
        }

        /**
         * Fallback para adicionar categoria quando main.js n√£o funciona
         */
        function addCategoryFallback(type, label) {
            console.log('[FALLBACK] Adicionando categoria:', type, label);
            
            // Carregar categorias existentes do localStorage
            let categories = {};
            try {
                const stored = localStorage.getItem('custom_categories_fallback');
                if (stored) {
                    categories = JSON.parse(stored);
                }
            } catch(e) {
                console.log('[FALLBACK] Erro ao carregar:', e.message);
            }
            
            // Inicializar estrutura se necess√°rio
            if (!categories.financial) categories.financial = {};
            if (!categories.financial[type]) categories.financial[type] = [];
            
            // Verificar se j√° existe
            const exists = categories.financial[type].some(cat => cat.label === label);
            if (exists) {
                alert('Kategorie existiert bereits');
                return;
            }
            
            // Adicionar nova categoria
            const value = label.toLowerCase().replace(/[^a-z0-9]/g, '_');
            categories.financial[type].push({ value, label, custom: true });
            
            // Salvar no localStorage
            localStorage.setItem('custom_categories_fallback', JSON.stringify(categories));
            
            // Limpar input
            const input = document.getElementById(`new${type.charAt(0).toUpperCase() + type.slice(1)}Category`);
            if (input) input.value = '';
            
            // Recarregar lista
            loadFinancialCategoryType(type);
            
            alert(`Kategorie "${label}" erfolgreich hinzugef√ºgt!`);
            console.log('[FALLBACK] Categoria adicionada com sucesso');
        }

        /**
         * Entfernt finanzielle Kategorie
         */
        function removeFinancialCategory(type, value) {
            const category = getCustomCategories('financial', type).find(cat => cat.value === value);
            if (!category) return;

            if (confirm(`M√∂chten Sie die Kategorie "${category.label}" wirklich l√∂schen?`)) {
                if (removeCustomCategory('financial', value, type)) {
                    loadFinancialCategoryType(type);
                    showNotification('Kategorie erfolgreich entfernt', 'success');
                }
            }
        }

        /**
         * F√ºgt Kategorie f√ºr einzelnen Typ hinzu
         */
        function addSingleCategory(type) {
            console.log('[DEBUG] addSingleCategory chamada para tipo:', type);
            
            const inputMap = {
                'recurring': 'newRecurringCategory',
                'inventory': 'newInventoryCategory',
                'preparations': 'newPreparationCategory',
                'employeeRoles': 'newEmployeeRole'
            };
            
            const input = document.getElementById(inputMap[type]);
            if (!input) {
                alert('ERRO: Input n√£o encontrado para tipo ' + type);
                return;
            }
            
            const label = input.value.trim();
            
            if (!label) {
                alert('Bitte geben Sie einen Namen ein');
                return;
            }

            // FALLBACK: Se main.js n√£o carregou, usar localStorage diretamente
            if (typeof addCustomCategory === 'undefined') {
                console.log('[DEBUG] main.js n√£o carregado para', type, ', usando fallback');
                alert('Sistema principal n√£o verf√ºgbar. Nur Finanz-Kategorien werden unterst√ºtzt.');
                return;
            }

            // Wert aus Label erstellen
            const value = label.toLowerCase().replace(/[^a-z0-9]/g, '_');
            
            try {
                if (addCustomCategory(type, value, label)) {
                    input.value = '';
                    loadSingleTypeCategories(type);
                    alert(`Kategorie "${label}" erfolgreich hinzugef√ºgt!`);
                } else {
                    alert('Fehler beim Hinzuf√ºgen der Kategorie');
                }
            } catch(error) {
                console.error('[DEBUG] Erro em addSingleCategory:', error);
                alert('Fehler: ' + error.message);
            }
        }

        /**
         * Entfernt Kategorie f√ºr einzelnen Typ
         */
        function removeSingleCategory(type, value) {
            const category = getCustomCategories(type).find(cat => cat.value === value);
            if (!category) return;

            if (confirm(`M√∂chten Sie die Kategorie "${category.label}" wirklich l√∂schen?`)) {
                if (removeCustomCategory(type, value)) {
                    loadSingleTypeCategories(type);
                    showNotification('Kategorie erfolgreich entfernt', 'success');
                }
            }
        }

        /**
         * Initialisiert Kategorien-Management
         */
        function initializeCategoryManagement() {
            console.log('[DEBUG] initializeCategoryManagement chamada');
            
            // Standard-Tab laden - SEMPRE carregar, mesmo se main.js falhar
            try {
                loadCategoriesForTab('financial');
            } catch(error) {
                console.log('[DEBUG] Erro ao carregar tab, usando fallback');
                loadFinancialCategories();
            }
            
            // EventBus Listener f√ºr Kategorie-√Ñnderungen
            if (typeof eventBus !== 'undefined') {
                try {
                    eventBus.on(EVENTS.DATA_CHANGED, (data) => {
                        if (data.type === 'category_added' || data.type === 'category_removed') {
                            // Aktiven Tab neu laden
                            const activeTab = document.querySelector('.category-tab.active');
                            if (activeTab) {
                                const tabName = activeTab.getAttribute('data-tab');
                                loadCategoriesForTab(tabName);
                            }
                        }
                    });
                } catch(error) {
                    console.log('[DEBUG] EventBus n√£o dispon√≠vel:', error.message);
                }
            } else {
                console.log('[DEBUG] EventBus n√£o encontrado');
            }
        }

        /**
         * Schlie√üt Daten-Modal
         */
        function closeDataModal() {
            document.getElementById('dataModal').style.display = 'none';
        }
    </script>
</body>
</html> 
