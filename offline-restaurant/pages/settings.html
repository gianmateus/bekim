<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Einstellungen - Restaurant-Verwaltung</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>‚öôÔ∏è Einstellungen</h1>
            <p>Daten verwalten und Systemeinstellungen</p>
        </div>
    </header>

    <div class="container">
        <!-- Navega√ß√£o -->
        <div class="nav-buttons">
            <button class="nav-button" onclick="navigateTo('dashboard')">
                <span class="icon icon-home"></span>
                √úbersicht
            </button>
        </div>

        <!-- Informa√ß√µes do sistema -->
        <div class="card">
            <h2>Systeminformationen</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalTransactions">0</div>
                    <div class="stat-label">Kassenfluss Eintr√§ge</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalInventoryItems">0</div>
                    <div class="stat-label">Inventar Artikel</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRecurringPayments">0</div>
                    <div class="stat-label">Wiederkehrende Zahlungen</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lastSaved">Nie</div>
                    <div class="stat-label">Zuletzt gespeichert</div>
                </div>
            </div>
        </div>

        <!-- Configura√ß√µes do restaurante -->
        <div class="card">
            <h2>Restaurant Einstellungen</h2>
            <form id="settingsForm">
                <div class="form-group">
                    <label for="restaurantName">Restaurant Name:</label>
                    <input type="text" id="restaurantName" placeholder="Mein Restaurant" required>
                </div>
                
                <div class="form-group">
                    <label for="currency">W√§hrung:</label>
                    <select id="currency" disabled>
                        <option value="EUR">Euro (‚Ç¨)</option>
                    </select>
                    <small style="color: #7f8c8d;">Die W√§hrung ist derzeit auf Euro festgelegt</small>
                </div>
                
                <button type="submit" class="btn btn-success">
                    <span class="icon icon-save"></span>
                    Einstellungen speichern
                </button>
            </form>
        </div>

        <!-- Automatisches Speichersystem -->
        <div class="card" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #28a745;">
            <h2 style="color: #28a745;">üíæ Automatisches Speichersystem</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">‚úÖ Automatisches Speichern Aktiv</h4>
                    <p style="color: #7f8c8d; margin-bottom: 15px; line-height: 1.6;">
                        Ihre Daten werden automatisch im Browser bei jeder √Ñnderung gespeichert. 
                        Manuelles Speichern ist nicht erforderlich!
                    </p>
                </div>
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">‚å®Ô∏è Tastaturk√ºrzel</h4>
                    <ul style="color: #7f8c8d; line-height: 1.8; margin: 0; padding-left: 20px;">
                        <li><strong>Strg+S</strong> - Schnelles Speichern</li>
                        <li><strong>Strg+E</strong> - Backup erstellen (Download)</li>
                    </ul>
                </div>
            </div>
            <div style="text-align: center; padding: 20px; background: rgba(40, 167, 69, 0.1); border-radius: 10px; margin-top: 20px;">
                <p style="color: #28a745; font-weight: bold; margin: 0;">
                    üîí Sichere Daten: Automatisches Speichern alle 30 Sekunden oder sofort nach √Ñnderungen
                </p>
            </div>
        </div>

        <!-- Export und Import von Daten -->
        <div class="card">
            <h2>Daten verwalten (Backup Manual)</h2>
            <p style="margin-bottom: 25px; color: #7f8c8d; line-height: 1.6;">
                Hier k√∂nnen Sie alle Ihre Restaurantdaten als JSON-Datei exportieren oder eine zuvor gespeicherte Datei importieren.
                <strong>Wichtig:</strong> Beim Import werden alle aktuellen Daten √ºberschrieben!
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
                <!-- Export -->
                <div style="text-align: center; padding: 30px; background: #f8f9fa; border-radius: 15px;">
                    <span class="icon icon-download" style="font-size: 3em; margin-bottom: 20px; display: block;"></span>
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">Daten exportieren</h3>
                    <p style="margin-bottom: 20px; color: #7f8c8d;">
                        Alle Daten als JSON-Datei herunterladen
                    </p>
                    <button class="btn btn-success" onclick="exportAllData()">
                        <span class="icon icon-download"></span>
                        Daten herunterladen
                    </button>
                </div>
                
                <!-- Import -->
                <div style="text-align: center; padding: 30px; background: #f8f9fa; border-radius: 15px;">
                    <span class="icon icon-upload" style="font-size: 3em; margin-bottom: 20px; display: block;"></span>
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">Daten importieren</h3>
                    <p style="margin-bottom: 20px; color: #7f8c8d;">
                        JSON-Datei hochladen und importieren
                    </p>
                    <div class="file-upload" onclick="document.getElementById('importFile').click()">
                        <input type="file" id="importFile" accept=".json" onchange="handleFileImport(event)">
                        <span class="icon icon-upload" style="font-size: 2em; margin-bottom: 10px; display: block;"></span>
                        <p><strong>Hier klicken oder Datei hierher ziehen</strong></p>
                        <p style="font-size: 0.9em; color: #7f8c8d;">Nur JSON-Dateien werden akzeptiert</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backup und Datenbereinigung -->
        <div class="card">
            <h2>Erweiterte Optionen</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                
                <div style="padding: 20px; border: 2px solid #3498db; border-radius: 10px;">
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">üîÑ Daten zur√ºcksetzen</h4>
                    <p style="color: #7f8c8d; margin-bottom: 15px; font-size: 0.9em;">
                        Alle gespeicherten Daten l√∂schen und das System zur√ºcksetzen
                    </p>
                    <button class="btn btn-warning" onclick="resetAllData()">
                        <span class="icon icon-delete"></span>
                        Alle Daten l√∂schen
                    </button>
                </div>
                
                <div style="padding: 20px; border: 2px solid #27ae60; border-radius: 10px;">
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">üìä Daten√ºbersicht</h4>
                    <p style="color: #7f8c8d; margin-bottom: 15px; font-size: 0.9em;">
                        Detaillierte Informationen √ºber gespeicherte Daten anzeigen
                    </p>
                    <button class="btn btn-success" onclick="showDataOverview()">
                        <span class="icon icon-settings"></span>
                        √úbersicht anzeigen
                    </button>
                </div>
                
                <div style="padding: 20px; border: 2px solid #e74c3c; border-radius: 10px;">
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">üíæ Lokaler Speicher</h4>
                    <p style="color: #7f8c8d; margin-bottom: 15px; font-size: 0.9em;">
                        Lokalen Browser-Speicher leeren (localStorage)
                    </p>
                    <button class="btn btn-danger" onclick="clearLocalStorage()">
                        <span class="icon icon-delete"></span>
                        Cache leeren
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal f√ºr Daten√ºbersicht -->
        <div id="dataModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto;">
                <h3 style="margin-bottom: 20px;">Daten√ºbersicht</h3>
                <div id="dataOverviewContent"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="closeDataModal()">Schlie√üen</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/eventBus.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/autoSave.js"></script>
    <script src="../js/restaurant-header.js"></script>
    <script>
        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // CORRIGIDO: Carregar dados ANTES de verificar sele√ß√£o
            loadDataFromStorage();
            
            checkRestaurantSelection();
            if (!isRestaurantSelected()) {
                return;
            }
            // updateRestaurantName() removido - esta p√°gina n√£o tem elemento #restaurantName
            initSettingsPage();
            updateSystemInfo();
            loadSettings();
        });

        /**
         * Inicializa a p√°gina de configura√ß√µes
         */
        function initSettingsPage() {
            // Event listener para formul√°rio de configura√ß√µes
            document.getElementById('settingsForm').addEventListener('submit', handleSettingsSubmit);
            
            // Configurar drag and drop para import
            const fileUpload = document.querySelector('.file-upload');
            
            fileUpload.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#3498db';
                this.style.background = '#ecf0f1';
            });
            
            fileUpload.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.borderColor = '#bdc3c7';
                this.style.background = 'transparent';
            });
            
            fileUpload.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '#bdc3c7';
                this.style.background = 'transparent';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileImport({ target: { files: files } });
                }
            });
        }

        /**
         * Atualiza informa√ß√µes do sistema
         */
        function updateSystemInfo() {
            const restaurantData = getCurrentRestaurantData();
            if (restaurantData) {
                document.getElementById('totalTransactions').textContent = (restaurantData.cashflow || []).length;
                document.getElementById('totalInventoryItems').textContent = (restaurantData.inventory || []).length;
                document.getElementById('totalRecurringPayments').textContent = (restaurantData.recurring || []).length;
            }
            
            // Pr√ºfen wann zuletzt gespeichert wurde
            const lastSaved = localStorage.getItem('restaurant_data_last_saved');
            if (lastSaved) {
                const lastSavedDate = new Date(lastSaved);
                document.getElementById('lastSaved').textContent = formatDate(lastSavedDate);
            } else {
                document.getElementById('lastSaved').textContent = 'Nie';
            }
        }

        /**
         * L√§dt aktuelle Einstellungen
         */
        function loadSettings() {
            const restaurantData = getCurrentRestaurantData();
            if (restaurantData && restaurantData.settings) {
                document.getElementById('restaurantName').value = restaurantData.settings.restaurantName || 'Mein Restaurant';
                document.getElementById('currency').value = restaurantData.settings.currency || 'EUR';
            }
        }

        /**
         * Behandelt Einstellungen-Formular
         */
        function handleSettingsSubmit(e) {
            e.preventDefault();
            
            const restaurantData = getCurrentRestaurantData();
            if (restaurantData) {
                if (!restaurantData.settings) restaurantData.settings = {};
                restaurantData.settings.restaurantName = document.getElementById('restaurantName').value;
                restaurantData.settings.currency = document.getElementById('currency').value;
            }
            
            saveDataToStorage();
            localStorage.setItem('restaurant_data_last_saved', new Date().toISOString());
            
            updateSystemInfo();
            showNotification('Einstellungen erfolgreich gespeichert', 'success');
        }

        /**
         * Exportiert alle Daten
         */
        function exportAllData() {
            try {
                const success = exportData();
                if (success) {
                    localStorage.setItem('restaurant_data_last_saved', new Date().toISOString());
                    updateSystemInfo();
                    showNotification('Daten erfolgreich exportiert', 'success');
                }
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Fehler beim Exportieren der Daten', 'error');
            }
        }

        /**
         * Behandelt Datei-Import
         */
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                showNotification('Bitte w√§hlen Sie eine JSON-Datei aus', 'error');
                return;
            }
            
            if (confirm('Achtung: Alle aktuellen Daten werden √ºberschrieben! M√∂chten Sie fortfahren?')) {
                importData(file)
                    .then(() => {
                        localStorage.setItem('restaurant_data_last_saved', new Date().toISOString());
                        updateSystemInfo();
                        showNotification('Daten erfolgreich importiert. Seite wird neu geladen...', 'success');
                        
                        // Seite nach 2 Sekunden neu laden
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    })
                    .catch(error => {
                        console.error('Import error:', error);
                        showNotification('Fehler beim Importieren: ' + error.message, 'error');
                    });
            }
            
            // Reset input
            event.target.value = '';
        }

        /**
         * Setzt alle Daten zur√ºck
         */
        function resetAllData() {
            const confirmation = prompt('Um alle Daten zu l√∂schen, geben Sie "L√ñSCHEN" ein:');
            
            if (confirmation === 'L√ñSCHEN') {
                // Reset current restaurant data
                const restaurantData = getCurrentRestaurantData();
                if (restaurantData) {
                    restaurantData.cashflow = [];
                    restaurantData.inventory = [];
                    restaurantData.employees = [];
                    restaurantData.preparations = [];
                    restaurantData.shopping = [];
                    restaurantData.settings = {
                        restaurantName: getCurrentRestaurantName(),
                        currency: '‚Ç¨'
                    };
                }
                
                saveDataToStorage();
                localStorage.removeItem('restaurant_data_last_saved');
                
                updateSystemInfo();
                loadSettings();
                
                showNotification('Alle Daten wurden erfolgreich gel√∂scht', 'success');
            } else if (confirmation !== null) {
                showNotification('Falsche Eingabe. Daten wurden nicht gel√∂scht.', 'error');
            }
        }

        /**
         * L√∂scht localStorage
         */
        function clearLocalStorage() {
            if (confirm('Sind Sie sicher, dass Sie den lokalen Cache leeren m√∂chten?')) {
                localStorage.clear();
                showNotification('Lokaler Cache wurde geleert', 'success');
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }
        }

        /**
         * Zeigt Daten√ºbersicht
         */
        function showDataOverview() {
            const modal = document.getElementById('dataModal');
            const content = document.getElementById('dataOverviewContent');
            
            // Detaillierte Statistiken berechnen
            const restaurantData = getCurrentRestaurantData();
            if (!restaurantData) return;
            
            const totalIncome = (restaurantData.cashflow || [])
                .filter(entry => entry.typ === 'einnahme')
                .reduce((sum, entry) => sum + parseFloat(entry.betrag || 0), 0);
            
            const totalExpenses = (restaurantData.cashflow || [])
                .filter(entry => entry.typ === 'ausgabe')
                .reduce((sum, entry) => sum + parseFloat(entry.betrag || 0), 0);
            
            const inventoryValue = (restaurantData.inventory || [])
                .reduce((sum, item) => sum + ((item.bestand || 0) * (item.preis || 0)), 0);
            
            const monthlyRecurringCosts = (restaurantData.recurring || []).reduce((sum, payment) => {
                let monthlyAmount = 0;
                switch (payment.frequency) {
                    case 'weekly': monthlyAmount = payment.amount * 4.33; break;
                    case 'monthly': monthlyAmount = payment.amount; break;
                    case 'quarterly': monthlyAmount = payment.amount / 3; break;
                    case 'yearly': monthlyAmount = payment.amount / 12; break;
                    case 'custom': monthlyAmount = payment.amount; break;
                }
                return sum + monthlyAmount;
            }, 0);
            
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-value">${formatCurrency(totalIncome)}</div>
                        <div class="stat-label">Gesamte Einnahmen</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatCurrency(totalExpenses)}</div>
                        <div class="stat-label">Gesamte Ausgaben</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatCurrency(totalIncome - totalExpenses)}</div>
                        <div class="stat-label">Nettosaldo</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatCurrency(inventoryValue)}</div>
                        <div class="stat-label">Inventarwert</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatCurrency(monthlyRecurringCosts)}</div>
                        <div class="stat-label">Monatliche Fixkosten</div>
                    </div>
                </div>
                
                <h4>Kategorieverteilung Kassenfluss:</h4>
                <div style="margin-bottom: 20px;">
                    ${generateCategoryBreakdown()}
                </div>
                
                <h4>Inventar Status:</h4>
                <div style="margin-bottom: 20px;">
                    ${generateInventoryStatus()}
                </div>
                
                <h4>Systemdaten:</h4>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.9em;">
                    <p><strong>Datengr√∂√üe:</strong> ${(JSON.stringify(restaurantData).length / 1024).toFixed(2)} KB</p>
                    <p><strong>Erstellt:</strong> ${new Date().toLocaleString('de-DE')}</p>
                    <p><strong>Browser:</strong> ${navigator.userAgent.split(')')[0]})</p>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        /**
         * Erstellt Kategorien-Aufschl√ºsselung
         */
        function generateCategoryBreakdown() {
            const categories = {};
            
            (restaurantData.cashflow || []).forEach(entry => {
                if (!categories[entry.category]) {
                    categories[entry.category] = { income: 0, expense: 0 };
                }
                if (entry.type === 'income') {
                    categories[entry.category].income += entry.amount;
                } else {
                    categories[entry.category].expense += entry.amount;
                }
            });
            
            return Object.keys(categories).map(category => {
                const cat = categories[category];
                return `
                    <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #ecf0f1;">
                        <span>${category}</span>
                        <span>+${formatCurrency(cat.income)} / -${formatCurrency(cat.expense)}</span>
                    </div>
                `;
            }).join('');
        }

        /**
         * Erstellt Inventar-Status
         */
        function generateInventoryStatus() {
            const lowStock = (restaurantData.inventory || []).filter(item => (item.bestand || 0) > 0 && (item.bestand || 0) <= (item.mindestbestand || 0)).length;
            const outOfStock = (restaurantData.inventory || []).filter(item => (item.bestand || 0) <= 0).length;
            const adequate = (restaurantData.inventory || []).filter(item => (item.bestand || 0) > (item.mindestbestand || 0)).length;
            
            return `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <div style="text-align: center; padding: 10px; background: #d5f4e6; border-radius: 8px;">
                        <strong style="color: #27ae60;">${adequate}</strong><br>
                        <small>Ausreichend</small>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #ffeaa7; border-radius: 8px;">
                        <strong style="color: #f39c12;">${lowStock}</strong><br>
                        <small>Niedrig</small>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #fab1a0; border-radius: 8px;">
                        <strong style="color: #e74c3c;">${outOfStock}</strong><br>
                        <small>Ausverkauft</small>
                    </div>
                </div>
            `;
        }

        /**
         * Schlie√üt Daten-Modal
         */
        function closeDataModal() {
            document.getElementById('dataModal').style.display = 'none';
        }
    </script>
</body>
</html> 
